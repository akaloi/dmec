<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMECNET</title>
    <link rel="icon" href="https://imgur.com/5U14ceE.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'San Francisco', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f7;
            color: #333;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 1000px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none;
        }

        .form-container {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .form-container h2 {
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .form-container input[type="text"],
        .form-container input[type="password"],
        .form-container select {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            background-color: #f5f5f7;
            transition: border-color 0.2s;
        }

        .form-container input[type="text"]:focus,
        .form-container input[type="password"]:focus,
        .form-container select:focus {
            border-color: #007aff;
            outline: none;
        }

        .form-container button {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .form-container button:hover {
            background-color: #005ec2;
        }

        .form-container a {
            color: #007aff;
            text-decoration: none;
            margin-top: 15px;
            font-size: 14px;
        }

        .header {
            background-color: #f5f5f7;
            color: #1d1d1f;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #d2d2d7;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .header img {
            height: 40px;
            margin-right: 10px;
        }

        .container-mail {
            display: flex;
            height: calc(100vh - 120px);
        }

        .email-list {
            width: 30%;
            background-color: #f5f5f7;
            border-right: 1px solid #d2d2d7;
            overflow-y: auto;
            padding: 20px;
        }

        .email-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .email-item:hover {
            background-color: #e5e5ea;
        }

        .email-item h3 {
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: 600;
        }

        .email-item p {
            font-size: 14px;
            color: #636366;
        }

        .email-compose,
        .email-details {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .email-compose input[type="text"],
        .email-compose textarea,
        .email-details input[type="text"],
        .email-details textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            background-color: #f5f5f7;
            transition: border-color 0.2s;
        }

        .email-compose input[type="text"]:focus,
        .email-compose textarea:focus,
        .email-details input[type="text"]:focus,
        .email-details textarea:focus {
            border-color: #007aff;
            outline: none;
        }

        .email-compose textarea,
        .email-details textarea {
            height: 200px;
            resize: none;
        }

        .email-compose button {
            padding: 12px 20px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            align-self: flex-start;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .email-compose button:hover {
            background-color: #005ec2;
        }

        .profile-menu {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .profile-menu button {
            padding: 8px 16px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .profile-menu button:hover {
            background-color: #005ec2;
        }

        .profile-menu img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            object-fit: cover;
        }

        .email-details input,
        .email-details textarea {
            background-color: #f5f5f7;
            color: #333;
            border: none;
            outline: none;
        }

        .email-details input[readonly],
        .email-details textarea[readonly] {
            background-color: #e5e5ea;
            color: #333;
            border: none;
            outline: none;
            cursor: default;
        }

        .profile-form-avatar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .profile-form-avatar img {
            border-radius: 50%;
            width: 60px;
            height: 60px;
            object-fit: cover;
        }

        .profile-form-avatar input[type="text"] {
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            .container-mail {
                flex-direction: column;
            }

            .email-list {
                width: 100%;
                height: 200px;
            }

            .email-compose,
            .email-details {
                padding: 20px;
            }
        }

        .spoiler {
            margin-top: 20px;
        }

        .bbcode-container {
            overflow-x: auto;
            white-space: pre-wrap;
            background-color: #e5e5ea;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .copy-btn {
            background-color: #007aff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .copy-btn:hover {
            background-color: #005ec2;
        }
    </style>
</head>
<body>

    <!-- Giriş Formu -->
    <div class="container" id="loginForm">
        <div class="form-container">
            <h2>Giriş Yap</h2>
            <input type="text" id="loginEmail" placeholder="E-mail (sonu @dmec.gov olmalı)">
            <input type="password" id="loginPassword" placeholder="Şifre">
            <div style="margin-bottom: 20px; width: 100%; max-width: 400px;">
                <input type="checkbox" id="rememberMe"> <label for="rememberMe">Beni Hatırla</label>
            </div>
            <button onclick="login()">Giriş Yap</button>
            <a href="#" onclick="showRegister()">Hesabınız yok mu? Kayıt Ol</a>
        </div>
    </div>

    <!-- Kayıt Formu -->
    <div class="container hidden" id="registerForm">
        <div class="form-container">
            <h2>Kayıt Ol</h2>
            <input type="text" id="registerName" placeholder="Adınız Soyadınız">
            <input type="text" id="registerEmail" placeholder="E-mail (sonu @dmec.gov)">
            <input type="password" id="registerPassword" placeholder="Şifre">
            <input type="text" id="registerRank" placeholder="Rütbeniz">
            <input type="text" id="registerDivision" placeholder="Bulunduğunuz Division">
            <button onclick="register()">Kayıt Ol</button>
            <a href="#" onclick="showLogin()">Zaten bir hesabınız var mı? Giriş Yap</a>
        </div>
    </div>

    <!-- Mail Sistemi Arayüzü -->
    <div class="container hidden" id="mailSystem">
        <div class="header">
            <h1><img src="https://i.imgur.com/5U14ceE.png" alt="DMEC Logo"> Gönderilen Mailler</h1>
            <div class="profile-menu">
                <img id="avatarImg" src="https://i.imgur.com/5U14ceE.png" alt="Avatar">
                <button onclick="showProfileUpdate()">Profili Güncelle</button>
                <button onclick="showComposeEmail()">Mail Oluştur</button>
            </div>
        </div>
        <div class="container-mail">
            <!-- Mail Listesi -->
            <div class="email-list" id="emailList"></div>

            <!-- Mail Gönderme -->
            <div class="email-compose hidden" id="emailCompose">
                <h2>Yeni Mail Oluştur</h2>
                <input type="text" placeholder="Kime" id="recipient">
                <input type="text" placeholder="Konu" id="subject">
                <textarea placeholder="Mesaj" id="message"></textarea>
                <button onclick="sendEmail()">Gönder</button>
            </div>
        </div>
    </div>

    <!-- Profil Güncelleme Formu -->
    <div class="container hidden" id="profileForm">
        <div class="form-container">
            <h2>Profil Güncelle</h2>
            <div class="profile-form-avatar">
                <img id="currentAvatar" src="https://i.imgur.com/5U14ceE.png" alt="Avatar">
                <input type="text" id="profileAvatar" placeholder="Avatar Linki (Imgur)">
            </div>
            <input type="text" id="profileName" placeholder="Yeni Ad Soyad">
            <input type="text" id="profileEmail" placeholder="Yeni E-mail">
            <input type="password" id="profilePassword" placeholder="Yeni Şifre">
            <input type="text" id="profileRank" placeholder="Yeni Rütbe">
            <input type="text" id="profileDivision" placeholder="Yeni Division">
            <button onclick="updateProfile()">Güncelle</button>
            <a href="#" onclick="showMailSystem()">Mail Sistemine Geri Dön</a>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let sentEmails = JSON.parse(localStorage.getItem('sentEmails')) || [];

        // Kullanıcı daha önce giriş yaptıysa, bilgileri doldur
        if (currentUser) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('mailSystem').classList.remove('hidden');
            document.getElementById('avatarImg').src = currentUser.avatar || "https://i.imgur.com/5U14ceE.png";
            updateEmailList();
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showMailSystem() {
            document.getElementById('profileForm').classList.add('hidden');
            document.getElementById('mailSystem').classList.remove('hidden');
            updateEmailList();
        }

        function showComposeEmail() {
            document.getElementById('emailDetails').classList.add('hidden');
            document.getElementById('emailCompose').classList.remove('hidden');
            document.getElementById('emailList').classList.remove('hidden'); // Mail listesini göster
        }

        function openEmail(index) {
            const email = sentEmails[index];

            // Yeni pencere açma
            const emailWindow = window.open('', '_blank', 'width=600,height=700');

            // BBCode oluşturma
            const bbcode = `
[table]
[tr]
    [td][center][imgsize=100,100]https://i.imgur.com/5U14ceE.png[/imgsize][/center][/td]
    [td][center][size=150][font="Auto"][b]LS COUNTY DEPARTMENT OF MEDICAL EXAMINER-CORONER[/b][/font]
[font="Auto"]OPERATION DIVISION[/font][/size][/center][/td]
[/tr]
[/table]
[table]
[tr]
    [td]
[b]Kimden:[/b] ${email.from}
[b]Kime:[/b] ${email.recipient}
[b]Tarih:[/b] ${email.date}
[b]Saat:[/b] ${email.time}

${email.message}

Bilgilerinize Sunulur,
${email.rank} ${email.name}
${email.division}
[/td]
[/tr]
[/table]
`;

// Yeni pencereye mail bilgilerini ve BBCode'yi yaz
emailWindow.document.write(`
    <html lang="tr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mail Detayları</title>
        <style>
            body {
                font-family: 'San Francisco', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background-color: #f5f5f7;
                color: #333;
                padding: 20px;
            }
            h2 {
                margin-bottom: 20px;
                font-size: 24px;
                font-weight: 600;
                color: #1d1d1f;
            }
            p {
                margin-bottom: 10px;
                font-size: 16px;
            }
            textarea {
                width: 100%;
                height: 200px;
                padding: 10px;
                border: 1px solid #d2d2d7;
                border-radius: 8px;
                font-size: 16px;
                background-color: #f5f5f7;
                resize: none;
            }
            .spoiler {
                margin-top: 20px;
            }
            .bbcode-container {
                overflow-x: auto;
                white-space: pre-wrap;
                background-color: #e5e5ea;
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 10px;
            }
            .copy-btn {
                background-color: #007aff;
                color: white;
                padding: 8px 16px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }
            .copy-btn:hover {
                background-color: #005ec2;
            }
        </style>
    </head>
    <body>
        <h2>Mail Detayları</h2>
        <p><strong>Kimden:</strong> ${email.from}</p>
        <p><strong>Kime:</strong> ${email.recipient}</p>
        <p><strong>Konu:</strong> ${email.subject}</p>
        <p><strong>Tarih ve Saat:</strong> ${email.date} ${email.time}</p>
        <p><strong>Konu:</strong> ${email.subject}</p>
        <textarea readonly>${email.message}</textarea>

        <!-- Spoiler ile BBCode -->
        <div class="spoiler">
            <details>
                <summary>BBCode'yi Göster</summary>
                <div class="bbcode-container">${bbcode.replace(/`/g, '\\`')}</div> <!-- backtick kaçırma -->
            </details>
        </div>
    </body>
    </html>
`);
            // Pencere içeriğini düzenli göstermek için focus yapıyoruz
            emailWindow.document.close();
            emailWindow.focus();
        }

        function showProfileUpdate() {
            document.getElementById('mailSystem').classList.add('hidden');
            document.getElementById('profileForm').classList.remove('hidden');
            document.getElementById('currentAvatar').src = currentUser.avatar || "https://i.imgur.com/Fc3iXZP.png";
        }

        function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const rank = document.getElementById('registerRank').value.trim();
            const division = document.getElementById('registerDivision').value.trim();

            if (name && email.endsWith('@dmec.gov') && password.length >= 6 && rank && division) {
                const existingUser = users.find(u => u.email === email);
                if (existingUser) {
                    alert('Bu e-mail adresi zaten kayıtlı.');
                    return;
                }

                users.push({ name, email, password, rank, division, avatar: "https://i.imgur.com/Fc3iXZP.png" });
                localStorage.setItem('users', JSON.stringify(users));
                alert('Kayıt başarılı, şimdi giriş yapabilirsiniz.');
                showLogin();
            } else {
                alert('Lütfen tüm alanları doğru şekilde doldurun. E-mail @dmec.gov ile bitmeli ve şifre en az 6 karakter olmalı.');
            }
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mailSystem').classList.remove('hidden');
                document.getElementById('avatarImg').src = currentUser.avatar || "hhttps://i.imgur.com/Fc3iXZP.png";
                alert(`Hoş geldiniz, ${user.name}`);

                if (rememberMe) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                } else {
                    localStorage.removeItem('currentUser');
                }

                updateEmailList();
            } else {
                alert('E-mail veya şifre yanlış.');
            }
        }

        function updateProfile() {
            const newName = document.getElementById('profileName').value.trim();
            const newEmail = document.getElementById('profileEmail').value.trim();
            const newPassword = document.getElementById('profilePassword').value;
            const newRank = document.getElementById('profileRank').value.trim();
            const newDivision = document.getElementById('profileDivision').value.trim();
            const newAvatar = document.getElementById('profileAvatar').value.trim();

            if (currentUser) {
                if (newName) currentUser.name = newName;
                if (newEmail.endsWith('@dmec.gov')) currentUser.email = newEmail;
                if (newPassword.length >= 6) currentUser.password = newPassword;
                if (newRank) currentUser.rank = newRank;
                if (newDivision) currentUser.division = newDivision;
                if (newAvatar) currentUser.avatar = newAvatar;

                users = users.map(u => u.email === currentUser.email ? currentUser : u);
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('avatarImg').src = currentUser.avatar || "https://i.imgur.com/Fc3iXZP.png";
                document.getElementById('currentAvatar').src = currentUser.avatar || "https://i.imgur.com/Fc3iXZP.png";
                alert('Profil güncellendi.');
            }
        }

        function sendEmail() {
            const recipient = document.getElementById('recipient').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();

            if (recipient && subject && message) {
                const newEmail = {
                    from: currentUser.email,
                    recipient,
                    subject,
                    message,
                    time: new Date().toLocaleTimeString(),
                    date: new Date().toLocaleDateString(),
                    rank: currentUser.rank,
                    name: currentUser.name,
                    division: currentUser.division
                };

                sentEmails.push(newEmail);
                localStorage.setItem('sentEmails', JSON.stringify(sentEmails));
                updateEmailList();

                document.getElementById('recipient').value = '';
                document.getElementById('subject').value = '';
                document.getElementById('message').value = '';

                // BBCode oluşturma
                const bbcode = `
[table]
[tr]
    [td][center][imgsize=100,100]https://i.imgur.com/5U14ceE.png[/imgsize][/center][/td]
    [td][center][size=150][font="Auto"][b]LS COUNTY DEPARTMENT OF MEDICAL EXAMINER-CORONER[/b][/font]
[font="Auto"]OPERATION DIVISION[/font][/size][/center][/td]
[/tr]
[/table]
[table]
[tr]
    [td]
[b]Kimden:[/b] ${newEmail.from}
[b]Kime:[/b] ${newEmail.recipient}
[b]Tarih:[/b] ${newEmail.date}
[b]Saat:[/b] ${newEmail.time}

[b]Konu:[/b] ${newEmail.subject}

${newEmail.message}

Bilgilerinize Sunulur,
${newEmail.rank} ${newEmail.name}
${newEmail.division}
[/td]
[/tr]
[/table]
`;

                // BBCode'yi kopyala
                navigator.clipboard.writeText(bbcode).then(() => {
                    alert('BBCode başarıyla kopyalandı!');
                }).catch(err => {
                    alert('BBCode kopyalanamadı: ' + err);
                });

                alert('Mail başarıyla gönderildi.');
            } else {
                alert('Lütfen tüm alanları doldurun.');
            }
        }

        function updateEmailList() {
    const emailList = document.getElementById('emailList');
    emailList.innerHTML = '';

    if (sentEmails.length === 0) {
        emailList.innerHTML = '<p>Gönderilmiş mailiniz bulunmamaktadır.</p>';
        return;
    }

    // Gönderilen mailleri en yeni tarihten eskiye doğru sıralama
    sentEmails.sort((a, b) => {
        const dateA = new Date(`${a.date} ${a.time}`);
        const dateB = new Date(`${b.date} ${b.time}`);
        return dateB - dateA; // Yeni tarih önce gelmeli
    });

    // Sıralanmış mailleri listeleme
    sentEmails.forEach((email, index) => {
        const emailItem = document.createElement('div');
        emailItem.className = 'email-item';
        emailItem.innerHTML = `
            <div>
                <h3>${email.recipient}</h3>
                <p>${email.subject}</p>
            </div>
            <div class="time">${email.date} ${email.time}</div>
        `;
        emailItem.onclick = () => openEmail(index);
        emailList.appendChild(emailItem);
    });
}


        window.onload = function() {
            if (currentUser) {
                showMailSystem();
            }
        }
    </script>

</body>
</html>
